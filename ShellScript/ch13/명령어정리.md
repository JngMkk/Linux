# 13장 퍼블릭 클라우드 사용

```
클라우드 시스템을 가장 쉽게 사용하는 방법은 바로 퍼블릭 클라우드 시스템을 사용하는 것.
클라우드 시스템 사용이 대중화되면서, 많은 개발자들은 클라우드에서 제공하는 인스턴스를 활용하여 개발.
물론 클라우드 시스템에서는 인스턴스와 같은 가상자원을 생성할 수 있는 포털을 제공함.
또한, 개발자들의 편의를 위해 CLI 기반의 가상자원 생성 명령어들을 함께 제공함.
```



## 1. AWS CLI 사용 환경 만들기

#### 상황

```
AWS 클라우드 시스템에서 개발하면 가상자원을 생성할 수 있는 포털 화면을 제공하지만,
개발자들이 주로 사용하는 REST API나 CLI를 함께 제공함.
개발 환경이 리눅스일 경우, CLI를 사용할 수 있는 환경을 만들어 놓고 개발하면 더 효율적임.
```



#### 방법 찾기

```
AWS CLI 설치 방법은 인터넷을 검색하면 쉽게 찾을 수 있음.
애플리케이션을 설치할 때는 가장 최신 버전을 설치하는 것이 좋음.
```

- 필요한 정보
  - AWS CLI 버전2 설치 가이드
    - [aws](https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/)
  - sudo 권한을 가진 계정 정보
- 프로세스
  - AWS CLI 설치 파일을 다운로드
  - Unzip을 이용해 다운로드 받은 설치 파일 압축 해제
  - aws/install 명령어를 이용해 CLI 설치
  - 설치가 끝나면 AWS CLI 버전 확인



#### 스크립트 생성

```sh
#!/bin/bash

echo "awscli download"
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
echo "unzip awscliv2.zip"
unzip awscliv2.zip
echo "install aws cli"
sudo ./aws/install -i /usr/local/aws-cli -b /usr/local/bin
aws --version
```

---



## 2. AWS CLI를 이용하여 인스턴스 만들기

#### 상황

```
CLI를 이용해 인스턴스를 만들기 위해서는 우선 인증을 해야 함.
이때, 어떤 리전에 인스턴스를 생성할 것인지, 어떤 계정을 이용하여 인스턴스를 생성할 것인지를 먼저 정의해야 함.
AWS EC2를 이용하여 인스턴스를 생성할 정보를 사전에 조회해 와야 함.
해당 정보들을 이용하여 인스턴스를 생성.
```



#### 방법 찾기

- 필요한 정보
  - AWS 인증 정보
  - CLI를 이용한 AWS EC2 인스턴스 생성 가이드
    - [ec2](https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/cli-services-ec2-instances.html)
  - 이미지 정보 조회 명령어 : aws ec2 describe-images
  - 인스턴스 타입 조회 명령어 : aws ec2 describe-instance-types
  - 키페어 조회 명령어 : aws ec2 describe-key-pairs
  - 보안그룹 조회 명령어 : aws ec2 describe-security-groups
  - 서브넷 조회 명령어 : aws ec2 describe-subnets
  - 인스턴스 생성 명령어 : aws ec2 run-instances
- 프로세스
  - aws cli를 사용하기 위해서 우선 인증을 함
  - 사전에 aws ec2 describe-images 명령어를 이용하여 생성한 이미지 ID를 검색함
  - 인스턴스 타입 정보를 간략하게 보여주고, 인스턴스 타입명을 입력받음
  - 키페어 정보를 간략하게 보여주고, 키페어 정보를 입력받음
  - 보안그룹 정보를 간략하게 보여주고, 보안그룹 정보를 입력받음
  - 서브넷 정보를 간략하게 보여주고, 서브넷 정보를 입력받음
  - 앞에서 입력받은 정보들을 이용하여 인스턴스 생성



#### 스크립트 생성

> 보안에 안전한 스크립트 생성하기 위해서는 명령어를 실행하기 위한
>
> 파라미터값을 스크립트 실행자로부터 입력을 받도록 구현하는 것

```sh
#!/bin/bash

# 인증
aws configure

# 이미지 정보 입력
read -p "Input image id : " imgid

# 인스턴스 타입 정보 입력
echo "==== Instance Type List ===="
aws ec2 describe-instance-types | grep InstanceType | grep t2
read -p "Input instance type : " instancetype

# 키페어 정보 입력
echo "==== Key Pair List ===="
aws ec2 describe-key-pairs | grep KeyName
read -p "Input key-pair name : " keyname

# 보안그룹 정보 입력
echo "==== Security Group List ===="
aws ec2 describe-security-groups | grep -e GroupName -e GroupId
read -p "Input security group id : " securitygrpid

# 서브넷 정보 입력
echo "==== Subnet List ===="
aws ec2 describe-subnets | grep -e SubnetId -e CidrBlock
read -p "Input subnet id : " subnetid

# EC2 인스턴스 생성
aws ec2 run-instances \
--image-id $imgid \
--count 1 \
--instance-type $instancetype \
--key-name $keyname \
--security-group-ids $securitygrpid \
--subnet-id $subnetid
```

---



## 3. 구글 클라우드 CLI 사용 환경 만들기

#### 상황

```
AWS 다음으로 가장 많이 사용하는 퍼블릭 클라우드는 구글 클라우드.
구글 클라우드 역시 웹 인터페이스인 웹 콘솔을 제공하지만, 개발자들을 위해 CLI 명령어를 제공함.
```



#### 방법 찾기

- 필요한 정보
  - 구글 클라우드 인증 정보
  - 구글 클라우드 CLI 설치 가이드
    - [GCP](https://cloud.google.com/sdk/docs/downloads-apt-get?hl=ko)
- 프로세스
  - 운영체제 타입 확인
  - 페도라 계열이면 구글 클라우드 SDK 저장소 추가
  - 구글 클라우드 SDK 설치
  - 설치가 되면 gcloud init 실행
  - 운영체제가 데비안 계열이면 클라우드 SDK URI 추가
  - 패키지 apt-transport-https를 설치
  - 구글 클라우드 공개 키를 가져옴
  - 구글 클라우드 SDK를 설치함
  - 설치가 끝나면 gcloud init를 실행



#### 스크립트 생성

```sh
#!/bin/bash

ostype=$(cat /etc/*release | grep ID_LIKE | sed "s/ID_LIKE=//;s/\"//g")

if [[ $ostype == "fedora" ]]; then
    
    # 구글 클라우드 SDK 저장소 추가
    echo "==== Add gcloud SDK repository ===="
    sudo tee -a /etc/yum.repos.d/google-cloud-sdk.repo << EOM
[google-cloud-sdk]
name=Google Cloud SDK
baseurl=https://packages.cloud.google.com/yum/repos/cloud-sdk-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
       https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOM

    # 구글 클라우드 SDK 설치
    echo "==== Install gcloud SDK ===="
    sudo yum instsall google-cloud-sdk

    # gcloud init 실행
    echo "==== Exec gcloud init ===="
    gcloud init

elif [[ $ostype == "debian" ]]; then
    # 클라우드 SDK 배포 URI 추가
    echo "==== Add gcloud sdk uri ===="
    echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list

    # 패키지 apt-transport-https 설치
    echo "==== Install apt-transport-https ===="
    sudo apt-get install apt-transport-https ca-certificates gnupg

    # 구글 클라우드 공개 키 가져오기
    echo "==== Getting gcloud key ===="
    curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -

    # 구글 클라우드 SDK 설치
    echo "==== Install gcloud SDK ===="
    sudo apt-get update && sudo apt-get install google-cloud-sdk

    # gcloud init 실행
    echo "==== Exec gcloud init ===="
    gcloud init

fi
```



## 4. 구글 클라우드 CLI를 사용해서 인스턴스 만들기

#### 상황

```
물론 구글 클라우드 역시 웹 콘솔을 제공하지만, 개발자라면 웹 콘솔보다는 명령어를 이용하여 인스턴스를 생성할 수 있어야 함.
```



#### 방법 찾기

- 필요한 정보
  - 구글 클라우드 인스턴스 생성 가이드
    - [GCP](https://cloud.google.com/compute/docs/instances/create-start-instance?hl=ko#startingstancegcloud)
  - 이미지 정보 조회 명령어 : gcloud compute images list
  - 부팅 디스크 유형 조회 명령어 : gcloud compute disk-types list
  - 머신 타입 조회 명령어 : gcloud compute machine-types list
  - 인스턴스 생성 명령어 : gcloud compute instaces create
- 프로세스
  - 인스턴스명을 입력받음
  - 이미지 목록을 보여주고, 생성하고자 하는 이미지 정보 입력받음
  - 부팅 디스크 유형을 보여주고, 부팅 디스크 유형을 입력받음
  - 부팅 디스크 사이즈 입력받음
  - 머신 타입 종류를 보여주고, 머신 타입 입력받음
  - 네트워크 목록을 보여주고, 네트워크를 입력받음
  - 앞에서 입력받은 정보를 가지고, 인스턴스를 생성함



#### 스크립트 생성

```sh
#!/bin/bash

# 서울은 asia-northeast3-a
ZONE="asia-northeast3-a"

# 인스턴스 이름 입력
read -p "Input instance name : " VM_NAME

# 이미지 정보 입력
echo "==== Images List ===="
gcloud compute images list | grep -e centos -e ubuntu -e rhel -e NAME
read -p "Input image family : " IMAGE
read -p "Input image project : " IMAGE_PROJECT

# 부팅 디스크 유형 입력
echo "==== Disk Type List ===="
gcloud compute disk-types list --zones $ZONE
read -p "Input disk type : " DISK_TYPE

# 부팅 디스크 사이즈 입력
read -p "Input disk size : " DISK_SIZE

# 머신 타입 입력
echo "==== Machine Type List ===="
gcloud compute machine-types list --zones $ZONE | grep n1-standard
read -p "Input machine type : " MACHINE_TYPE

# 네트워크 입력
echo "==== Network List ===="
gcloud compute networks list
read -p "Input network name : " NETWORK

# 인스턴스 생성
echo "==== Create Instance ===="
gcloud compute instances create $VM_NAME \
--image-family=$IMAGE \
--image-project=$IMAGE_PROJECT \
--boot-disk-type=$DISK_TYPE \
--boot-disk-size=$DISK_SIZE \
--machine-type=$MACHINE_TYPE \
--network=$NETWORK \
--zone=$ZONE
```

